<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ToDo一覧</title>
  <link rel="stylesheet" th:href="@{/style.css}">
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #2884fc; color: #ffffff; }
    .actions form { display: inline; }
    .checkbox-cell { text-align: center; width: 40px; }
    .message { margin: 12px 0; color: #666; }
    .completed-row { background: #E2E8F0; color: #64748B; }
    .incomplete-row { background: #FFFFFF; }
    .bulk-mode { background: #fff5f5; }
    tr.bulk-selected { outline: 2px solid #E53935; outline-offset: -2px; }
    .bulk-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid #f1b5b5;
      background: #fffafa;
      margin: 12px 0;
    }
    .bulk-actions { display: flex; gap: 8px; align-items: center; }
    .bulk-count { font-weight: bold; }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f1f1f1;
      color: #444;
      text-decoration: none;
    }
    .icon-btn:hover { background: #e3e3e3; }
    .new-todo-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #2964E6;
      color: #E0F2FE;
      font-size: 24px;
      line-height: 1;
      text-decoration: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .new-todo-btn:hover { background: #1D4ED8; }
    .category-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }
    .priority-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .icon-group {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    #search-panel { display: none; }
    #search-panel.open { display: block; }
  </style>
</head>
<body th:classappend="${bulk} ? 'bulk-mode' : ''">
  <div class="page-header">
    <h1>ToDo一覧</h1>
    <p class="icon-group" th:if="${!bulk}">
      <a class="new-todo-btn" th:href="@{/todos/new}" title="新規追加" aria-label="新規追加">＋</a>
      <button class="icon-btn" type="button" id="search-toggle" title="検索" aria-label="検索">🔍</button>
      <a class="icon-btn" th:href="@{/categories}" title="カテゴリ編集" aria-label="カテゴリ編集">🏷</a>
      <a class="icon-btn" th:href="@{/todos(bulk=true)}" title="一括削除モード" aria-label="一括削除モード">🗑</a>
    </p>
  </div>

  <div id="search-panel"
       th:if="${!bulk}"
       th:classappend="${(q != null && q != '') or categoryId != null or priority != null or sort != 'createdAt' or dir != 'desc'} ? ' open' : ''">
    <form id="search-form" method="get" th:action="@{/todos}">
      <label>検索:
        <input type="text" name="q" th:value="${q}">
      </label>
      <label>並び替え:
        <select name="sort" th:value="${sort}">
          <option value="createdAt" th:selected="${sort == 'createdAt'}">作成日</option>
          <option value="updatedAt" th:selected="${sort == 'updatedAt'}">更新日</option>
          <option value="title" th:selected="${sort == 'title'}">タイトル</option>
          <option value="author" th:selected="${sort == 'author'}">作成者</option>
          <option value="completed" th:selected="${sort == 'completed'}">状態</option>
          <option value="priority" th:selected="${sort == 'priority'}">優先度</option>
        </select>
      </label>
      <label>順序:
        <select name="dir" th:value="${dir}">
          <option value="asc" th:selected="${dir == 'asc'}">昇順</option>
          <option value="desc" th:selected="${dir == 'desc'}">降順</option>
        </select>
      </label>
      <label>カテゴリ:
        <select name="categoryId">
          <option value="" th:selected="${categoryId == null}">すべて</option>
          <option th:each="cat : ${categories}"
                  th:value="${cat.id}"
                  th:text="${cat.name}"
                  th:selected="${categoryId != null && categoryId == cat.id}"></option>
        </select>
      </label>
      <label>優先度:
        <select name="priority">
          <option value="" th:selected="${priority == null}">すべて</option>
          <option th:each="p : ${priorities}"
                  th:value="${p}"
                  th:text="${p.displayName}"
                  th:selected="${priority != null && priority == p}"></option>
        </select>
      </label>
      <a th:href="@{/todos}">クリア</a>
    </form>
  </div>

  <form id="bulk-form" method="post" th:if="${bulk}" th:action="@{/todos/bulk/confirm}">
    <div class="bulk-header">
      <span>🗑 一括削除モード</span>
      <a th:href="@{/todos}">一覧に戻る</a>
      <span class="bulk-count"><span id="bulk-count">0</span>件選択中</span>
      <div class="bulk-actions">
        <button type="button" id="bulk-select-all">全選択</button>
        <button type="button" id="bulk-clear">全解除</button>
        <button type="submit">削除</button>
      </div>
    </div>
    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </form>

  <div th:if="${#lists.isEmpty(todos)}" class="message">データはありません</div>

  <table th:if="${!#lists.isEmpty(todos)}">
    <thead>
      <tr>
        <th th:if="${bulk}">削除</th>
        <th></th>
        <th>No</th>
        <th>タイトル</th>
        <th>作成者</th>
        <th>カテゴリ</th>
        <th>優先度</th>
        <th>状態</th>
        <th>作成日</th>
        <th>更新日</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="todo, stat : ${todos}"
          th:class="${todo.completed} ? 'completed-row' : 'incomplete-row'"
          th:classappend="${bulk} ? ' bulk-row' : ''">
        <td th:if="${bulk}" class="checkbox-cell">
          <input class="bulk-select" type="checkbox" name="ids" th:value="${todo.id}" form="bulk-form">
        </td>
        <td class="checkbox-cell">
          <form method="post" th:action="@{/todos/{id}/toggle(id=${todo.id})}">
            <input type="checkbox" th:checked="${todo.completed}" onchange="this.form.submit()">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          </form>
        </td>
        <td th:text="${stat.count}">1</td>
        <td th:text="${todo.title}">タイトル</td>
        <td th:text="${todo.author}">作成者</td>
        <td>
          <span class="category-badge"
                th:if="${todo.category != null && todo.category.id != null}"
                th:text="${todo.category.name}"
                th:style="'background:' + ${todo.category.color} + ';'"></span>
          <span th:if="${todo.category == null || todo.category.id == null}">未分類</span>
        </td>
        <td>
          <span class="priority-badge"
                th:text="${todo.priority.displayName}"
                th:classappend="' ' + ${todo.priority.cssClass}"></span>
        </td>
        <td th:text="${todo.completed ? '完了' : '未完了'}">未完了</td>
        <td th:text="${#temporals.format(todo.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 00:00</td>
        <td th:text="${#temporals.format(todo.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 00:00</td>
        <td class="actions">
          <a th:href="@{/todos/{id}/edit(id=${todo.id})}">編集</a>
        </td>
      </tr>
    </tbody>
  </table>

  <script th:if="${bulk}">
    const bulkCount = document.getElementById('bulk-count');
    const selectAllBtn = document.getElementById('bulk-select-all');
    const clearBtn = document.getElementById('bulk-clear');
    const checkboxes = Array.from(document.querySelectorAll('input.bulk-select'));

    const updateCount = () => {
      const checkedCount = checkboxes.filter((cb) => cb.checked).length;
      bulkCount.textContent = checkedCount;
    };

    const syncRow = (cb) => {
      const row = cb.closest('tr');
      if (row) {
        row.classList.toggle('bulk-selected', cb.checked);
      }
    };

    checkboxes.forEach((cb) => {
      cb.addEventListener('change', () => {
        syncRow(cb);
        updateCount();
      });
    });

    document.querySelectorAll('tr.bulk-row').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('a') || event.target.closest('button') || event.target.closest('input')) {
          return;
        }
        const cb = row.querySelector('input.bulk-select');
        if (cb) {
          cb.checked = !cb.checked;
          syncRow(cb);
          updateCount();
        }
      });
    });

    selectAllBtn.addEventListener('click', () => {
      checkboxes.forEach((cb) => {
        cb.checked = true;
        syncRow(cb);
      });
      updateCount();
    });

    clearBtn.addEventListener('click', () => {
      checkboxes.forEach((cb) => {
        cb.checked = false;
        syncRow(cb);
      });
      updateCount();
    });

    updateCount();
  </script>
  <script th:if="${!bulk}">
    const searchToggle = document.getElementById('search-toggle');
    const searchPanel = document.getElementById('search-panel');
    const searchInput = document.querySelector('#search-panel input[name="q"]');

    const openSearchPanel = () => {
      if (!searchPanel) {
        return;
      }
      searchPanel.classList.add('open');
      if (searchInput) {
        searchInput.focus();
      }
    };

    if (searchToggle && searchPanel) {
      searchToggle.addEventListener('click', () => {
        const isOpen = searchPanel.classList.toggle('open');
        if (isOpen && searchInput) {
          searchInput.focus();
        }
      });
    }

    if (searchPanel && searchPanel.classList.contains('open')) {
      openSearchPanel();
    }
  </script>
</body>
</html>
