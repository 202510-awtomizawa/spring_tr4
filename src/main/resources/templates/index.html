<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <title>ToDo一覧</title>
  <link rel="stylesheet" th:href="@{/style.css}">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #2884fc;
      color: #ffffff;
    }

    .actions form {
      display: inline;
    }

    .checkbox-cell {
      text-align: center;
      width: 40px;
    }

    .title-cell {
      text-align: left;
      width: 70%;
    }

    .task-title-wrap {
      display: flex;
      align-items: center;
    }

    .task-check {
      width: 48px;
      min-width: 48px;
      max-width: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 1em;
    }

    .custom-check-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .custom-check-label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }

    .custom-check-label::before {
      content: "";
      width: 20px;
      height: 20px;
      border: 2px solid #4b5563;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      color: #2563eb;
      box-sizing: border-box;
      background: transparent;
    }

    .custom-check-input:checked+.custom-check-label::before {
      content: "✔";
    }

    .col-hidden {
      display: none;
    }

    .message {
      margin: 12px 0;
      color: #666;
    }

    .no-data {
      text-align: center;
    }

    .completed-row {
      background: #E2E8F0;
      color: #64748B;
    }

    .incomplete-row {
      background: #FFFFFF;
    }

    .completed-row td.deadline-overdue,
    .completed-row td.deadline-today,
    .completed-row td.deadline-soon {
      background: #E2E8F0;
      color: #64748B;
    }

    .bulk-mode {
      background: #fff5f5;
    }

    tr.bulk-selected {
      outline: 2px solid #E53935;
      outline-offset: -2px;
    }

    .bulk-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid #f1b5b5;
      background: #fffafa;
      margin: 12px 0;
    }

    .bulk-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .bulk-count {
      font-weight: bold;
    }

    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f1f1f1;
      color: #444;
      text-decoration: none;
    }

    .icon-btn:hover {
      background: #e3e3e3;
    }

    .new-todo-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #2964E6;
      color: #E0F2FE;
      font-size: 36px;
      line-height: 1;
      text-decoration: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.20);
    }

    .new-todo-btn:hover {
      background: #1D4ED8;
    }

    .new-todo-wrap {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
      padding-right: 40px;
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }

    .page-header {
      text-align: center;
    }

    .todo-header-card {
      background: transparent;
      border: 0;
      padding: 0;
      margin-bottom: 12px;
      box-shadow: none;
      display: none;
    }

    .todo-header-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0 auto;
      padding: 12px 20px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.10);
    }

    .todo-header-title span {
      font-size: 180px;
      font-weight: bold;


    }

    .todo-header-icon {
      font-size: 20px;
    }

    .main-content {
      padding: 0;
    }

    .main-header-bar {
      height: 54px;
      background: #FFFFFF;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 24px;
      margin: 0;
      width: 100%;
      box-sizing: border-box;
      color: #333333;
      font-size: 2.2em;
      line-height: 1;
      border-bottom: 1px solid #E0E0E0;
    }

    .icon-group {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: absolute;
      right: 0;
    }

    .csv-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #111827;
      text-decoration: none;
      font-size: 13px;
    }

    .csv-btn:hover {
      background: #eef2f7;
    }

    #search-panel {
      display: none;
    }

    #search-panel.open {
      display: block;
    }

    .todo-table-card {
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      box-sizing: border-box;
    }

    .todo-table tr {
      height: 65px;
    }

    .todo-table td {
      vertical-align: middle;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 200px;
      height: 100%;
      background: #f8fafc;
      border-right: 1px solid #e5e7eb;
      padding: 24px 12px;
      box-sizing: border-box;
      transition: width 0.2s ease;
    }

    .sidebar-title {
      font-weight: bold;
      margin-bottom: 12px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-item {
      margin: 0;
    }

    .sidebar-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      color: #111827;
      text-decoration: none;
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 14px;
    }

    .sidebar-link:hover {
      background: #eef2f7;
      border-color: #d1d5db;
    }

    .sidebar-icon {
      width: 20px;
      text-align: center;
    }

    .has-sidebar .main-content {
      margin-left: 200px;
    }

    .sidebar.sidebar-collapsed {
      width: 56px;
    }

    .sidebar.sidebar-collapsed .sidebar-title {
      display: none;
    }

    .sidebar.sidebar-collapsed .sidebar-text {
      display: none;
    }

    .sidebar.sidebar-collapsed .sidebar-link {
      justify-content: center;
    }

    .sidebar.sidebar-collapsed~.main-content {
      margin-left: 56px;
    }

    .sidebar:not(.sidebar-collapsed) .sidebar-toggle {
      position: absolute;
      top: 12px;
      right: 12px;
    }

    .pager {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: center;
      margin: 16px 0 8px;
    }

    .pager a,
    .pager span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      padding: 0 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      text-decoration: none;
      color: #111827;
      background: #fff;
      font-size: 14px;
    }

    .pager .active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
      font-weight: bold;
    }

    .pager .disabled {
      color: #9ca3af;
      border-color: #e5e7eb;
      pointer-events: none;
      background: #f9fafb;
    }

    .pager-summary {
      text-align: center;
      color: #4b5563;
      margin: 8px 0 16px;
      font-size: 14px;
    }
  </style>
</head>

<body th:classappend="${bulk} ? 'bulk-mode' : 'has-sidebar'">
  <aside class="sidebar" th:if="${!bulk}">
    <button class="sidebar-toggle" type="button" aria-label="サイドバー切替">≡</button>
    <div class="sidebar-title">メニュー</div>
    <ul class="sidebar-menu">
      <li class="sidebar-item">
        <button class="sidebar-link" type="button" id="search-toggle" title="検索" aria-label="検索">
          <span class="sidebar-icon">🔍</span>
          <span class="sidebar-text">検索</span>
        </button>
      </li>
      <li class="sidebar-item">
        <a class="sidebar-link" th:href="@{/todos(bulk=true)}" title="一括削除モード" aria-label="一括削除モード">
          <span class="sidebar-icon">🗑</span>
          <span class="sidebar-text">一括削除</span>
        </a>
      </li>
      <li class="sidebar-item">
        <a class="sidebar-link" th:href="@{/categories}" title="カテゴリ編集" aria-label="カテゴリ編集">
          <span class="sidebar-icon">🏷</span>
          <span class="sidebar-text">カテゴリ編集</span>
        </a>
      </li>
      <li class="sidebar-item" sec:authorize="hasRole('ADMIN')">
        <a class="sidebar-link" th:href="@{/admin/users}" title="ユーザー管理" aria-label="ユーザー管理">
          <span class="sidebar-icon">🛠</span>
          <span class="sidebar-text">ユーザー管理</span>
        </a>
      </li>
      <li class="sidebar-item">
        <a class="sidebar-link" th:href="@{/todos/export/csv}" title="CSVダウンロード" aria-label="CSVダウンロード">
          <span class="sidebar-icon">⬇</span>
          <span class="sidebar-text">CSVダウンロード</span>
        </a>
      </li>
      <li class="sidebar-item" sec:authorize="isAuthenticated()">
        <a class="sidebar-link" th:href="@{/logout}" title="ログアウト" aria-label="ログアウト">
          <span class="sidebar-icon">👤</span>
          <span class="sidebar-text">ログアウト</span>
        </a>
      </li>
      <li class="sidebar-item" sec:authorize="isAnonymous()">
        <a class="sidebar-link" th:href="@{/login}" title="ログイン" aria-label="ログイン">
          <span class="sidebar-icon">👤</span>
          <span class="sidebar-text">ログイン</span>
        </a>
      </li>
    </ul>
  </aside>

  <div class="main-content">
    <div class="main-header-bar">ToDoリスト</div>
    <div class="page-header todo-header-card">
      <h1 class="todo-header-title"><span class="todo-header-icon">📋</span>ToDo一覧</h1>
    </div>

    <div id="search-panel" th:if="${!bulk}"
      th:classappend="${(q != null && q != '') or categoryId != null or priority != null or sort != 'createdAt' or dir != 'desc'} ? ' open' : ''">
      <form id="search-form" method="get" th:action="@{/todos}">
        <label>検索:
          <input type="text" name="q" th:value="${q}">
        </label>
        <label>並び替え:
          <select name="sort" th:value="${sort}">
            <option value="createdAt" th:selected="${sort == 'createdAt'}">作成日</option>
            <option value="updatedAt" th:selected="${sort == 'updatedAt'}">更新日</option>
            <option value="title" th:selected="${sort == 'title'}">タイトル</option>
            <option value="author" th:selected="${sort == 'author'}">作成者</option>
            <option value="completed" th:selected="${sort == 'completed'}">状態</option>
            <option value="priority" th:selected="${sort == 'priority'}">優先度</option>
            <option value="deadline" th:selected="${sort == 'deadline'}">期限</option>
          </select>
        </label>
        <label>順序:
          <select name="dir" th:value="${dir}">
            <option value="asc" th:selected="${dir == 'asc'}">昇順</option>
            <option value="desc" th:selected="${dir == 'desc'}">降順</option>
          </select>
        </label>
        <label>カテゴリ:
          <select name="categoryId">
            <option value="" th:selected="${categoryId == null}">すべて</option>
            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"
              th:selected="${categoryId != null && categoryId == cat.id}"></option>
          </select>
        </label>
        <label>優先度:
          <select name="priority">
            <option value="" th:selected="${priority == null}">すべて</option>
            <option th:each="p : ${priorities}" th:value="${p}" th:text="${p.displayName}"
              th:selected="${priority != null && priority == p}"></option>
          </select>
        </label>
        <a th:href="@{/todos}">クリア</a>
      </form>
    </div>

    <form id="bulk-form" method="post" th:if="${bulk}" th:action="@{/todos/bulk/confirm}">
      <div class="bulk-header">
        <span>🗑 一括削除モード</span>
        <a th:href="@{/todos}">一覧に戻る</a>
        <span class="bulk-count"><span id="bulk-count">0</span>件選択中</span>
        <div class="bulk-actions">
          <button type="button" id="bulk-select-all">全選択</button>
          <button type="button" id="bulk-clear">全解除</button>
          <button type="submit">削除</button>
        </div>
      </div>
      <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>

    <div th:if="${#lists.isEmpty(todos)}" class="message no-data">データはありません</div>

    <div class="todo-table-card" th:if="${!#lists.isEmpty(todos)}">
      <table class="todo-table">
        <tbody>
          <tr th:each="todo, stat : ${todos}" th:class="${todo.completed} ? 'completed-row' : 'incomplete-row'"
            th:classappend="${bulk} ? ' bulk-row' : ''">
            <td class="title-cell">
              <div class="task-title-wrap">
                <span class="task-check" th:if="${bulk}">
                  <input class="bulk-select custom-check-input" type="checkbox" name="ids" th:value="${todo.id}"
                    form="bulk-form" th:id="'bulk-' + ${todo.id}">
                  <label class="custom-check-label" th:for="'bulk-' + ${todo.id}"></label>
                </span>
                <span class="task-check" th:if="${!bulk}">
                  <form method="post" th:action="@{/todos/{id}/toggle(id=${todo.id})}">
                    <input class="custom-check-input" type="checkbox" th:checked="${todo.completed}"
                      onchange="this.form.submit()" th:id="'toggle-' + ${todo.id}">
                    <label class="custom-check-label" th:for="'toggle-' + ${todo.id}"></label>
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}">
                  </form>
                </span>
                <span th:text="${todo.title}">タイトル</span>
              </div>
            </td>
            <td class="col-hidden" th:text="${stat.count}">1</td>
            <td class="col-hidden" th:text="${todo.author}">作成者</td>
            <td class="col-hidden">
              <span class="category-badge" th:if="${todo.category != null && todo.category.id != null}"
                th:text="${todo.category.name}" th:style="'background:' + ${todo.category.color} + ';'"></span>
              <span th:if="${todo.category == null || todo.category.id == null}">未分類</span>
            </td>
            <td class="col-hidden">
              <span class="priority-badge" th:text="${todo.priority.displayName}"
                th:classappend="' ' + ${todo.priority.cssClass}"></span>
            </td>
            <td class="col-hidden"
              th:classappend="${((todo.deadline != null && todo.isOverdue()) ? ' deadline-overdue' : '') + ((todo.deadline != null && todo.getDaysUntilDeadline() == 0) ? ' deadline-today' : '') + ((todo.deadline != null && todo.getDaysUntilDeadline() > 0 && todo.getDaysUntilDeadline() <= 3) ? ' deadline-soon' : '')}"
              th:text="${todo.deadline != null ? #temporals.format(todo.deadline, 'yyyy/MM/dd') : ''}"></td>
            <td class="col-hidden" th:text="${todo.completed ? '完了' : '未完了'}">未完了</td>
            <td class="col-hidden" th:text="${#temporals.format(todo.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 00:00
            </td>
            <td class="col-hidden" th:text="${#temporals.format(todo.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 00:00
            </td>
            <td class="col-hidden actions">
              <a th:href="@{/todos/{id}/edit(id=${todo.id})}">編集</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pager-summary" th:if="${page != null}">
      <span th:text="'全' + ${page.totalElements} + '件中 ' + ${rangeStart} + '-' + ${rangeEnd} + '件を表示'">
        全0件中 0-0件を表示
      </span>
    </div>

    <div class="pager" th:if="${page != null && page.totalPages > 1}">
      <a th:classappend="${page.first} ? ' disabled' : ''"
        th:href="@{/todos(page=${page.number - 1}, size=${page.size}, q=${q}, categoryId=${categoryId}, priority=${priority}, sort=${sort}, dir=${dir}, bulk=${bulk})}">前へ</a>
      <a th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
        th:classappend="${i == page.number} ? ' active' : ''"
        th:text="${i + 1}"
        th:href="@{/todos(page=${i}, size=${page.size}, q=${q}, categoryId=${categoryId}, priority=${priority}, sort=${sort}, dir=${dir}, bulk=${bulk})}">1</a>
      <a th:classappend="${page.last} ? ' disabled' : ''"
        th:href="@{/todos(page=${page.number + 1}, size=${page.size}, q=${q}, categoryId=${categoryId}, priority=${priority}, sort=${sort}, dir=${dir}, bulk=${bulk})}">次へ</a>
    </div>

    <div class="new-todo-wrap" th:if="${!bulk}">
      <a class="new-todo-btn" th:href="@{/todos/new}" title="新規登録" aria-label="新規登録">＋</a>
    </div>
  </div>

  <script th:src="@{/sidebar.js}"></script>
  <script th:if="${bulk}">
    const bulkCount = document.getElementById('bulk-count');
    const selectAllBtn = document.getElementById('bulk-select-all');
    const clearBtn = document.getElementById('bulk-clear');
    const checkboxes = Array.from(document.querySelectorAll('input.bulk-select'));

    const updateCount = () => {
      const checkedCount = checkboxes.filter((cb) => cb.checked).length;
      bulkCount.textContent = checkedCount;
    };

    const syncRow = (cb) => {
      const row = cb.closest('tr');
      if (row) {
        row.classList.toggle('bulk-selected', cb.checked);
      }
    };

    checkboxes.forEach((cb) => {
      cb.addEventListener('change', () => {
        syncRow(cb);
        updateCount();
      });
    });

    document.querySelectorAll('tr.bulk-row').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('a') || event.target.closest('button') || event.target.closest('input')) {
          return;
        }
        const cb = row.querySelector('input.bulk-select');
        if (cb) {
          cb.checked = !cb.checked;
          syncRow(cb);
          updateCount();
        }
      });
    });

    selectAllBtn.addEventListener('click', () => {
      checkboxes.forEach((cb) => {
        cb.checked = true;
        syncRow(cb);
      });
      updateCount();
    });

    clearBtn.addEventListener('click', () => {
      checkboxes.forEach((cb) => {
        cb.checked = false;
        syncRow(cb);
      });
      updateCount();
    });

    updateCount();
  </script>
  <script th:if="${!bulk}">
    const searchToggle = document.getElementById('search-toggle');
    const searchPanel = document.getElementById('search-panel');
    const searchInput = document.querySelector('#search-panel input[name="q"]');

    const openSearchPanel = () => {
      if (!searchPanel) {
        return;
      }
      searchPanel.classList.add('open');
      if (searchInput) {
        searchInput.focus();
      }
    };

    if (searchToggle && searchPanel) {
      searchToggle.addEventListener('click', () => {
        const isOpen = searchPanel.classList.toggle('open');
        if (isOpen && searchInput) {
          searchInput.focus();
        }
      });
    }

    if (searchPanel && searchPanel.classList.contains('open')) {
      openSearchPanel();
    }
  </script>
</body>

</html>
